---
title: baidu AFS
key: 20180812
---
baidu AFS


AFS 百度系分布式存储系统

<!--more-->
## AFS文件两种写入方式：

1.### pipeline方式写入：

   > 以三副本A、B、C为例,以Client->A->B->C的方式进行数据的复制。其优点是能够最大化利用Client网卡的吞吐，但缺 点也是很明显的，一旦A、B、C任意一点出现慢节点，规避的代价会比较大。

2.### 分发方式写入：

   > AFS同时支持分发的写入方式，即Client直接向A、B、C分发写请求。分 发的优缺点刚好和pipeline相反，其缺点是，多副本会平分Client的网卡出口带宽，以千兆网三副本为例，写入性能只能达到33MB/s，这一缺 点在千兆网环境下很明显，但随着百度内万兆网机房的推广，对于大多数场景，这一问题就不再成为问题。

分发的优点是很容易规避慢节点;考虑到现阶段百度内还有许多千兆网机房，我们在AFS支持上述两种写入方式。用户可以在写打开一个文件的时候，指定采用分发方式或者pipeline方式。对于特别关注写入延时的应用，推荐使用分发的方式。

## 以下分别叙述在两种模式下，AFS对写入在低延时方面的优化：

## 对于pipeline的写入方式：
    -慢节点剔除策略：
    > Client会记录读、写请求在每个Data Node上的耗时。当Client检测到每次写请求的响应时间超过可容忍的阈值后，会根据最近的写请求所带回来的A、B、C节点各自的响应时间（需要注意 的是，例如B节点的响应时间，其实包括了A->B的网络延时加上B节点上的处理时间），主动在pipeline中剔除响应最慢的节点。其中加入了许多自适应的判断，以避免在全集群都很繁忙的情况下盲目踢节点。

对于分发的写入方式：
    -quorum:
    > 在分发的方式下，能够更好的规避慢节点。AFS支持在写入的时候指定Quorum，例 如，对于三副本的文件，用户可以指定写入两副本就算成功，在这种情况下，每次写请求只要收集到两个Data Node给返回Ack，就会给前端返回写成功，另一个Ack异步返回，不阻塞API的调用。
    -慢节点剔除策略：
    > 当某个节点总是响应特别慢的时候，AFS支持直接剔除该节点， 只向剩余的节点进行分发。

无论哪种写入方式，剔除副本都有可能导致写入副本数变少。AFS允许用户指定safe replica，例如，用户可以指定safe replica为2，当写入过程中，当副本数小于2时，Client会主动发起修复。只有等到副本数满足safe replica数的时候，用户调用的close才会返回，否则会被阻塞至副本满足条件，或超时。

## AFS多租户

AFS的多租户主要是通过Region的划分，以及用户和Region的绑定来实现的。














