---
title: baidu AFS
key: 20180812
---
baidu AFS


AFS 百度系分布式存储系统

<!--more-->
### AFS文件两种写入方式：

1.pipeline方式写入：

   > 以三副本A、B、C为例,以Client->A->B->C的方式进行数据的复制。其优点是能够最大化利用Client网卡的吞吐，但缺 点也是很明显的，一旦A、B、C任意一点出现慢节点，规避的代价会比较大。

2.分发方式写入：

   > AFS同时支持分发的写入方式，即Client直接向A、B、C分发写请求。分 发的优缺点刚好和pipeline相反，其缺点是，多副本会平分Client的网卡出口带宽，以千兆网三副本为例，写入性能只能达到33MB/s，这一缺 点在千兆网环境下很明显，但随着百度内万兆网机房的推广，对于大多数场景，这一问题就不再成为问题。

分发的优点是很容易规避慢节点;考虑到现阶段百度内还有许多千兆网机房，我们在AFS支持上述两种写入方式。用户可以在写打开一个文件的时候，指定采用分发方式或者pipeline方式。对于特别关注写入延时的应用，推荐使用分发的方式。

### 以下分别叙述在两种模式下，AFS对写入在低延时方面的优化：

### 对于pipeline的写入方式： 

   -慢节点剔除策略:
   > Client会记录读、写请求在每个Data Node上的耗时。当Client检测到每次写请求的响应时间超过可容忍的阈值后，会根据最近的写请求所带回来的A、B、C节点各自的响应时间（需要注意 的是，例如B节点的响应时间，其实包括了A->B的网络延时加上B节点上的处理时间），主动在pipeline中剔除响应最慢的节点。其中加入了许多自适应的判断，以避免在全集群都很繁忙的情况下盲目踢节点。

对于分发的写入方式：

   -quorum:
   > 在分发的方式下，能够更好的规避慢节点。AFS支持在写入的时候指定Quorum，例 如，对于三副本的文件，用户可以指定写入两副本就算成功，在这种情况下，每次写请求只要收集到两个Data Node给返回Ack，就会给前端返回写成功，另一个Ack异步返回，不阻塞API的调用。

   -慢节点剔除策略：
   > 当某个节点总是响应特别慢的时候，AFS支持直接剔除该节点， 只向剩余的节点进行分发。

无论哪种写入方式，剔除副本都有可能导致写入副本数变少。AFS允许用户指定safe replica，例如，用户可以指定safe replica为2，当写入过程中，当副本数小于2时，Client会主动发起修复。只有等到副本数满足safe replica数的时候，用户调用的close才会返回，否则会被阻塞至副本满足条件，或超时。

### AFS多租户

AFS的多租户主要是通过Region的划分，以及用户和Region的绑定来实现的。AFS支持将一批机器设定为一个Region，并且支持将该Region设置为可信Region.
   > 每个AFS账户必须和一个或多个Region绑定 后才可写入数据。当绑定一个Region时，AFS会确保该账户的所有数据均落在该Region所包含的机器内；当绑定多个Region时，AFS会确保 该账户的数据分布在不同的Region内;
### 可信region(数据安全性高的region)      
   > 当账户绑定的多个Region内有1个或更多的可信Region时，AFS会确保写入的数据至少有一个副本放置在可信Region内.
#### 解释一下可信Region的作用
   > 以像log36这样的日志备份业务为例，这类业务的特点是，数据量很大，数据存储必须可靠，但是落到数据上 的访问比较少。目前这类数据存放在独立预算的Peta集群内，存储成本很高。公司内目前有两种低成本的存储资源，一种是Avaton服务器+低功耗的备份 盘，其特点是成本低，备份盘在空闲的时候会进入深度休眠，耗电量非常小，但读取之前需要唤醒备份盘，有数十秒的延迟；另一种是已采购机器的空余磁盘空间， 可以通过混布加以利用，这部分的存储空间巨大，但混布管理较为复杂，例如一旦某个业务OP未按正常流程重装了系统，则会导致上面的数据全部丢失。因此，我们未来规划中，对于这类备份业务，会将Avaton服务器作为可信Region，确保在Avaton服务器上至少放置1个副本以保证数据的安全性，然后在 混布存储上放置剩余副本以降低读延迟。

## AFS支持多种存储设备和介质
   > 从Server级别看，AFS支持Avaton，ARM，以及Xeon服务器，对于Xeon服务器，又划分为混布和独立；从介质级别看，AFS支持内存、SSD、磁盘、冷备盘，并且可以很容易的支持未来新引入的存储介质。
   > 可以通过设定Region的方式，让一个业务的数据（不只是租户）都放在某一个Region内，例如，备份业务可以和冷备盘+Avaton服务器组成的Region绑定。
   > AFS支持在创建文件的时候指定将文件放在磁盘上，或者是SSD上，只要该用户所绑定的Region内包含这两种存储介质。创建之后，文件会和指定的介质绑定，即如果一个指定放在SSD上的文件，未来将会一直放在SSD上。
   > AFS还支持将写入的内容暂时保留在内存里。在用户写打开一个文件的时候，AFS还支持用户指定，写入数据在Data Node的内存中保持的时间。   在这段时间里，数据会只在Data Node的内存中，不会产生I/O。超时后Data Node才将数据持久化。这个特点特别适合类似于流式计算等应用，上游产生的文件立刻会被下游消费，消费完成后数据即删除。这样，绝大多数时候中间文件生存时间非常短，不需要落盘，减少了磁盘I/O带来的延时。

   














